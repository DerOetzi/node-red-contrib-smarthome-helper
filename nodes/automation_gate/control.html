<script type="text/javascript">
    RED.nodes.registerType('gate-control', {
        category: 'automation gate',
        defaults: {
            name: { value: "" },
            delay: { value: 100, required: true },
            gateCommand: { value: "start", required: true },
            pauseTime: { value: 1, required: false },
            pauseUnit: { value: "s", required: false },
            enableTrigger: { value: false },
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["Gate Command Output", "Delayed Message Output"],
        icon: 'timer.svg',
        label: function () {
            var label = this.name || this.gateCommand;

            if (this.gateCommand === "pause") {
                label += " (" + this.pauseTime + " " + this.pauseUnit + ")";
            }

            return label;
        },
        oneditprepare: function () {
            $("#pause-options").toggle($("#node-input-gateCommand").val() === "pause");

            $("#node-input-gateCommand").on("change", function () {
                $("#pause-options").toggle($(this).val() === "pause");
            });
        },
        button: {
            enabled: function () {
                return !this.changed;
            },
            visible: function () {
                return this.enableTrigger;
            },
            onclick: function () {
                const node = this;

                if (node.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }

                $.ajax({
                    url: "smarthomehelper/automation_gate/control/" + node.id,
                    type: "POST",
                    data: JSON.stringify({ trigger: true }),
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function () {
                        RED.notify(node._("inject.in-progress", { label: node.label }), { type: "info", id: "inject", timeout: 1000 });
                    },
                    success: function (resp) {
                        RED.notify(node._("inject.success", { label: node.label }), { type: "success", id: "inject", timeout: 2000 });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                        } else {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                        }
                    }
                });
            }
        },
    });
</script>

<script type="text/html" data-template-name="gate-control">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-delay"><i class="fa fa-clock-o"></i> Delay (ms)</label>
        <input type="number" id="node-input-delay" min="0" value="100">
    </div>
    <div class="form-row">
        <label for="node-input-gateCommand"><i class="fa fa-toggle-on"></i> Gate Command</label>
        <select id="node-input-gateCommand">
            <option value="start">Start</option>
            <option value="stop">Stop</option>
            <option value="pause">Pause</option>
            <option value="replay">Replay</option>
            <option value="reset_filter">Reset Filter</option>
        </select>
    </div>
    <div class="form-row" id="pause-options">
        <label for="node-input-pauseTime"><i class="fa fa-clock"></i> Pause Time</label>
        <input type="number" id="node-input-pauseTime" min="1" value="0">
        <select id="node-input-pauseUnit">
            <option value="s">s</option>
            <option value="m">m</option>
            <option value="h">h</option>
            <option value="d">d</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-enableTrigger"><i class="fa fa-bolt"></i> Enable trigger button</label>
        <input type="checkbox" id="node-input-enableTrigger">
    </div>
    <style>
        #pause-options div {
            display: flex;
            align-items: center;
        }

        #pause-options input[type="number"], #pause-options select {
            width: 50px;
        }
    </style>
</script>

<!-- Node help documentation -->
<script type="text/html" data-help-name="gate-control">
    <p>The <b>Gate Control</b> node is used to manage the flow of messages based on specific gate commands. You can use this
        node to start, stop, pause, or replay the flow of messages, which is particularly useful in automation scenarios
        where dynamic control of message flow is needed.</p>
    
    <h4>Configuration Options:</h4>
    <dl>
        <dt><b>Name</b></dt>
        <dd>An optional name for the node, which helps identify it within the flow.</dd>
    
        <dt><b>Delay (ms)</b></dt>
        <dd>The time delay in milliseconds before the original message is forwarded. This can be used to control the timing
            of the message flow.</dd>
    
        <dt><b>Gate Command</b></dt>
        <dd>The command to be executed by the gate. Available options include:
            <ul>
                <li><code>start</code> - Opens the gate to allow messages to pass through.</li>
                <li><code>stop</code> - Closes the gate to stop the flow of messages.</li>
                <li><code>pause</code> - Pauses the flow of messages for a specified duration, defined by <b>Pause Time</b>
                    and <b>Pause Unit</b>.</li>
                <li><code>replay</code> - Replays the last message received by the gate.</li>
                <li><code>reset_filter</code> - Resets the filter to allow messages with previously identical payloads to
                    pass through again.</li>
            </ul>
        </dd>
    
        <dt><b>Pause Time</b></dt>
        <dd>Specifies the duration for which the gate will be paused if the <b>Gate Command</b> is set to
            <code>pause</code>.</dd>
    
        <dt><b>Pause Unit</b></dt>
        <dd>The unit of time for the pause duration. Options include seconds (s), minutes (m), hours (h), and days (d).</dd>
    
        <dt><b>Enable Trigger Button</b></dt>
        <dd>Enables a manual trigger button in the editor, allowing you to manually trigger the gate's action.</dd>
    </dl>
    
    <h4>Outputs:</h4>
    <ul>
        <li><b>Output 1</b> - Sends a gate control message..</li>
        <li><b>Output 2</b> - Sends the original message after the specified delay. </li>
    </ul>
    
    <h4>Usage Example:</h4>
    <p>Imagine an automated lighting system that requires precise control over when lights turn on or off based on various
        sensor inputs. You can use the Gate Control node to pause, delay, or replay messages to manage the lighting state
        effectively. For example, using the <code>pause</code> command, you could delay actions until certain conditions are
        met, providing more granular control.</p>
    </script>