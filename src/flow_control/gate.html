<script type="text/javascript" id="automation-gate">
    RED.nodes.registerType('automation-gate', {
        category: 'Smarthome Flow Control',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            startupState: { value: true },
            autoReplay: { value: true },
            filterUniquePayload: { value: false }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: [
            "Messages when gate is open", 
            "Gate state updates"
        ],
        icon: "gate.png",
        label: function () {
            return this.name || "automation-gate";
        }
    });
</script>

<!-- Node template -->
<script type="text/html" data-template-name="automation-gate">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name of the gate node">
    </div>
    <div class="form-row">
        <label for="node-input-startupState"><i class="fa fa-check"></i> Open on startup</label>
        <input type="checkbox" id="node-input-startupState">
    </div>
    <div class="form-row">
        <label for="node-input-autoReplay"><i class="fa fa-repeat"></i> Auto Replay after unpause</label>
        <input type="checkbox" id="node-input-autoReplay">
    </div>
    <div class="form-row">
        <label for="node-input-filterUniquePayload"><i class="fa fa-filter"></i> Filter unique payload</label>
        <input type="checkbox" id="node-input-filterUniquePayload">
    </div>
</script>

<!-- Node help documentation -->
<script type="text/html" data-help-name="automation-gate">
    <p>The <b>Automation Gate</b> node is used to control the flow of messages based on a gate mechanism. You can open or close the gate to control whether incoming messages are forwarded to the outputs. This is particularly useful for automation scenarios where you need to pause, filter, or manage message flow conditions.</p>

    <h4>Configuration Options:</h4>
    <dl>
        <dt><b>Name</b></dt>
        <dd>An optional name for the node, which will be displayed in the flow to help you identify it easily.</dd>

        <dt><b>Open on startup</b></dt>
        <dd>Specifies whether the gate should be open or closed when the flow starts. If checked, the gate will be open by default, allowing messages to pass through.</dd>

        <dt><b>Auto Replay after unpause</b></dt>
        <dd>If enabled, the last message for each topic will be replayed after the gate resumes operation (after a pause). This is helpful when you want to ensure that no important messages are lost while the gate is paused. Only the most recent message per topic will be replayed.</dd>

        <dt><b>Filter unique payload</b></dt>
        <dd>If enabled, the node will only forward messages with a unique payload for each topic. This helps to avoid sending redundant messages with identical payloads. The filter can be reset manually using the <code>reset_filter</code> command.</dd>
    </dl>

    <h4>Gate Commands:</h4>
    <p>The Automation Gate node also accepts special control messages through the <code>msg.gate</code> property to manage the state of the gate:</p>
    <ul>
        <li><code>pause</code> - Closes the gate for a specified duration (provided in <code>msg.pause</code> in milliseconds).</li>
        <li><code>stop</code> - Closes the gate and stops the flow of all messages.</li>
        <li><code>start</code> - Opens the gate, allowing messages to pass through.</li>
        <li><code>replay</code> - Replays the most recent stored message for each topic from the buffer regardless of whether they were previously forwarded.</li>
        <li><code>reset_filter</code> - Resets the payload filter, allowing identical messages to pass through again.</li>
    </ul>

    <h4>Outputs:</h4>
    <ul>
        <li><b>Output 1</b> - Passes messages when the gate is open. If <i>filter unique payload</i> is enabled, only messages with new, unique payloads are sent.</li>
        <li><b>Output 2</b> - Outputs the current state of the gate (open/closed) whenever the gate state changes.</li>
    </ul>

    <h4>Usage Example:</h4>
    <p>Consider a scenario where you have an automated irrigation system. You might want to control when the irrigation starts or stops based on sensor inputs or timing schedules. The Automation Gate node can be used to open the flow of water (messages) or pause it for a specified period. You could also filter identical sensor readings to avoid redundant actions.</p>
</script>